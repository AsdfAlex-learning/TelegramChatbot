# AI 女友机器人 — 长期记忆模块

## 一、核心目标

在保留现有短期对话上下文记忆的基础上，新增长期记忆模块（独立文件维护），实现以下能力：

- 记忆用户关键信息（如健康状态、人生大事、偏好等），仅在相关话题时自然提及，不干扰当前对话；
- 记忆具备衰减、更新与删除机制，避免冗余信息堆积；
- 与短期记忆解耦，保证代码可维护性；
- 控制 API 调用成本与频率，兼顾记忆效果与性能。

## 二、整体架构

模块 | 归属文件 | 核心职责
---|---:|---
短期记忆 | `bot.py` | 维护单轮对话上下文（10 轮内）、实时消息缓冲、API 调用、Telegram 交互
长期记忆 | `memory.py` | 管理长期记忆的存储、加载、更新、衰减与匹配触发，提供标准化接口
数据存储 | 双存储 | SQLite（运行时高效查询） + CSV（备份/持久化）

## 三、核心流程（精准逻辑）

### 3.1 初始化阶段（用户启动对话 / Bot 启动）

#### 3.1.1 触发条件

用户发送 `/start_aiGF` 开启对话模式时，触发长期记忆加载流程。

#### 3.1.2 执行步骤

- 用户记忆库初始化：
	- 检查该用户是否存在专属 SQLite 表（按 user_id 命名）及 CSV 备份文件；
	- 若无则创建：SQLite 表预设字段 `id`（主键）、`事件`、`关键词`、`重要程度(0-100)`、`创建时间`、`有效期`、`最后提及时间`；CSV 同步相同表头。
- 记忆过滤加载：
	- 从 SQLite 读取该用户所有记忆项，过滤出「未过期 && 重要程度 ≥ 30」的有效记忆（低价值记忆不加载）；
	- 有效期规则：永久（核心属性）、30 天（临时事件）、7 天（轻量偏好）。
- 轻量化 `USER_PROMPT` 生成：
	- 检查内存中是否存在该用户 24 小时内缓存的 `USER_PROMPT`；
	- 若无缓存：调用 DeepSeek API，将过滤后的有效记忆发给 AI，要求按「核心层 + 动态层」生成 ≤200 字的 `USER_PROMPT`：
		- 核心层（必加）：用户核心属性（示例：25 岁，程序员，生日 10.1，重要度 100），始终融入系统提示；
		- 动态层（按需加）：临时事件（示例：2025-12-23 感冒，重要度 80），仅在关键词匹配时加入；
	- 若有缓存：直接使用缓存，避免重复调用 API。
- 提示词融合：将 `USER_PROMPT` 融入 `SYSTEM_PROMPT`，作为 AI 回复的长期记忆基础。

### 3.2 对话阶段（实时交互）

#### 3.2.1 触发条件

用户发送非命令类消息，且处于 ai 女友对话模式时。

#### 3.2.2 执行步骤

- 关键词提取：提取当前用户输入的核心关键词（示例：“好累” → 累、疲惫、没精神）。
- 记忆匹配触发：
	- 遍历该用户 SQLite 中「重要度 ≥ 50」的记忆项，匹配关键词（示例：“感冒”的关键词：感冒、生病、不舒服、发烧）；
	- 匹配规则：模糊匹配（关键词包含即可），最多匹配 1–2 条；
	- 频率控制：同一记忆项每间隔至少 5 轮对话才能触发一次。
- 上下文动态补充：
	- 匹配成功：将对应的动态层记忆项临时加入本次 API 调用的上下文（仅本次有效）；
	- 匹配失败：不加入长期记忆，仅用短期上下文回复。
- AI 回复约束：
	- 系统提示词要求：优先回复当前对话内容，仅当话题相关时，自然提及 1 条长期记忆（示例：“对了，你昨天说感冒了，今天好点了吗？😘”），不强行关联、不频繁提及；
	- 回复生成后，若提及某条记忆项，更新该记忆项的「最后提及时间」。

### 3.3 记忆更新阶段（总结与迭代）

#### 3.3.1 触发条件（满足其一即执行）

- 基础触发：用户累计对话 8–12 轮（随机化以避免机械性）；
- 主动触发：对话中出现高重要度关键词（例如生病、离职、生日、恋爱等）。

#### 3.3.2 执行步骤

- 对话总结与记忆提取：
	- 调用 DeepSeek API，传入最近 10 轮对话上下文，按标准化格式提取新记忆点；
	- 重要度量化规则：
		- 健康相关（生病、受伤）：80–100；
		- 人生大事（换工作、恋爱、生日）：70–90；
		- 偏好（喜欢吃辣、讨厌下雨）：40–60；
		- 普通闲聊（今天吃了米饭）：0–20；
	- 事件格式：`YYYY-MM-DD + 具体事件`（示例：2025-12-23 感冒发烧）；
	- 关键词格式：逗号分隔（示例：感冒，发烧，不舒服）；
	- API 返回结果仅保留 ≤50 字的核心记忆点，以控制 token 消耗。
- 旧记忆衰减：
	- 对该用户所有记忆项执行衰减逻辑：
		- 基础衰减：每过 1 天，重要度 = 原重要度 × 0.95；
		- 衰减减免：若「最后提及时间」在 7 天内，衰减系数改为 0.98；
		- 衰减后重要度 < 10 的记忆项标记为“待删除”。
- 新记忆插入：
	- 将 API 提取的新记忆项插入 SQLite 表；
	- 去重规则：同一事件重复出现时，保留最新且重要度最高的一条，删除旧项。
- 冗余记忆删除：
	- 本地删除规则（不依赖 API）：
		- 重要度 < 10 的记忆项；
		- 有效期已过且「最后提及时间」超过 7 天的记忆项；
		- 重复的低价值记忆项；
	- 数据同步：将更新后的 SQLite 表同步至 CSV 备份（每天凌晨全量备份一次）。

### 3.4 关闭对话阶段

#### 3.4.1 触发条件

用户发送 `/stop_aiGF` 关闭对话模式时。

#### 3.4.2 执行步骤

- 清空该用户短期上下文（`chat_context`）、消息缓冲区（`user_message_buffer`）、计时器（`user_timers`）；
- 保留长期记忆库（SQLite + CSV）不删除；
- 清理该用户的 `USER_PROMPT` 缓存（下次启动时如需重新生成）。

## 四、性能与鲁棒性保障

### 4.1 数据安全

- 读写锁保护：对每个用户记忆库操作加独立线程锁，避免多线程读写冲突；
- 备份机制：CSV 每日凌晨全量备份，SQLite 使用事务以防数据丢失；
- 容错处理：API 调用失败时，使用本地缓存的 `USER_PROMPT` 继续对话，不中断核心功能。

### 4.2 性能优化

- 存储效率：SQLite 用于运行时高效查询（关键词匹配可用 `LIKE`），CSV 仅作备份；
- API 成本控制：
	- `USER_PROMPT` 缓存 24 小时，避免重复生成；
	- 总结记忆时仅提取核心信息，减少 token 消耗；
	- 支持批量处理多用户的记忆总结请求（若 DeepSeek API 支持）；
- 资源占用：长期记忆库仅加载有效记忆，避免全量加载导致内存占用过高。

## 五、核心约束规则（确保体验符合预期）

- 自然度约束：长期记忆提及频率 ≤ 20%（每 5 轮对话最多 1 次），且仅在相关话题时提及；
- 优先级约束：当前对话内容优先级高于长期记忆，AI 回复不得偏离当前话题强行关联记忆；
- 记忆有效性约束：临时事件（如感冒）有效期 30 天，过期后重要度快速衰减，避免无效记忆堆积；
- 标准化约束：所有记忆项的格式、重要度量化与关键词提取遵循统一规则，保证一致性。