# 个性化语言聊天机器人 - 开发计划

## 项目概述
本项目是一款**基于微信聊天记录的个性化AI伴侣机器人**，支持“提示词级+模型级”双层个性化，结合本地存储（SQLite）与轻量级模型微调，实现精准的真人风格模仿，同时具备插件化、可扩展的工程架构。


## 一、阶段1：基础架构与个性化底座搭建（2周）
### 核心目标
搭建支持“用户级个性化”的稳定基础框架，为后续功能铺路。

### 任务清单
1. **配置系统重构：支持个性化分层配置**
   - 迁移配置格式：从JSON→YAML+Pydantic
   - 新增`personality`配置分层：默认人格 + 用户自定义人格
   - 定义`PersonalityConfig`模型：包含`pet_phrases`（口头禅）、`sentence_style`（句式）、`emotion_tendency`（情感倾向）等字段
   - 实现配置优先级：用户配置 > 环境配置 > 默认配置

2. **日志系统重构：新增个性化行为日志**
   - 按模块拆分日志文件：`main.log`（核心服务）、`personality.log`（个性化行为）、`error.log`（异常）
   - `personality.log`需包含：`user_id`、`personality_id`、操作类型（如“更新人格”“匹配记忆”）
   - 支持日志轮转：保留最近7天的个性化日志

3. **统一启动入口：集成个性化服务初始化**
   - 编写`run.py`作为唯一入口，支持命令行参数：
     - `--env`：指定环境（dev/test/prod）
     - `--personality`：启动时加载预设人格模板
   - 启动时自动初始化：用户个性化配置表（关联SQLite存储）、记忆库


## 二、阶段2：个性化功能核心落地（3周）
### 核心目标
实现“用户可自定义人格”的基础功能，关联微信聊天记录的个性化需求。

### 任务清单
1. **提示词管理系统：微信驱动的个性化提示词**
   - 功能：
     - 微信聊天记录导入：支持TXT/JSON格式，自动解析对话内容
     - 人格模板库：内置“温柔伴侣”“幽默朋友”等模板，支持用户修改
     - 提示词预览：实时测试不同提示词的风格匹配效果
   - 技术实现：
     - 解析脚本：提取聊天记录中的口头禅、句式特征
     - 提示词生成器：基于特征自动生成精细化提示词（如“回复用‘呀’‘呢’，句式≤10字”）

2. **本地聊天数据存储：个性化记忆的向量化检索**
   - 功能：
     - 记忆标签化：给记忆增加“个性化标签”（如“ta喜欢的电影”）
     - 语义级匹配：用`sentence-transformers`将记忆向量化，支持模糊语义检索
     - 衰减机制优化：“个性化标签记忆”衰减系数降低至`0.98/天`
   - 技术实现：
     - 扩展SQLite表字段：新增`tag`（标签）、`vector`（向量化数据）
     - 实现`get_relevant_memory_by_semantic()`方法：基于向量相似度匹配记忆

3. **统一API接口：封装个性化风格接口**
   - 新增接口：
     - `POST /api/personality/apply`：动态切换用户人格配置
     - `GET /api/personality/match_score`：返回当前回复与目标风格的匹配度
   - 接口规范：
     - 请求/响应格式标准化（JSON）
     - 支持请求缓存（有效期5分钟）


## 三、阶段3：微信数据驱动的个性化训练（4周）
### 核心目标
从“提示词级个性化”升级到“模型级个性化”，实现精准风格模仿。

### 任务清单
1. **微信聊天数据处理：风格特征自动提取**
   - 功能：
     - 微信记录解析：支持解密微信数据库、导出聊天记录
     - 特征提取：自动分析语言特征（词汇/句式）、情感特征（积极/消极占比）、互动特征（回复时长）
     - 生成风格报告：可视化展示目标人物的聊天风格
   - 技术实现：
     - 解析脚本：`wechat_parser.py`（支持Windows/macOS微信数据库）
     - 特征分析：用`jieba`分词、`snownlp`做情感分析

2. **提示词提取系统：特征到提示词的自动转换**
   - 功能：
     - 特征转提示词：基于风格报告生成精细化提示词
     - 提示词迭代：根据用户反馈自动调整特征权重
   - 技术实现：
     - 提示词模板引擎：动态注入特征参数
     - 反馈收集接口：`POST /api/personality/feedback`

3. **模型微调系统：轻量级个性化微调**
   - 功能：
     - 模型选择：支持Qwen-1.8B、ChatGLM-6B等轻量级模型
     - 微调方法：LoRA/P-Tuning（降低硬件资源占用）
     - 训练监控：可视化展示损失值、风格匹配度
   - 技术实现：
     - 微调脚本：`lora_finetune.py`（基于`peft`库）
     - 训练数据：微信聊天记录构造的“用户提问→目标回复”对话对


## 四、阶段4：混合推理与个性化服务优化（3周）
### 核心目标
让个性化服务更稳定、智能，适配本地/云端场景。

### 任务清单
1. **服务选择器：个性化需求驱动的智能路由**
   - 功能：
     - 风格优先级路由：开启个性化→调用本地微调模型；否则→调用云端API
     - 风格降级：本地模型不可用时，用“提示词+云端API”模拟目标风格
   - 技术实现：
     - 路由算法：`personality_router.py`（基于用户配置+服务状态）

2. **本地模型服务：个性化推理性能优化**
   - 功能：
     - 模型量化：用`llama.cpp`做4-bit量化，降低内存占用
     - 风格缓存：高频个性化回复缓存（有效期1小时）
   - 技术实现：
     - 推理引擎：`local_model_engine.py`（封装`llama.cpp`）
     - 缓存层：Redis（或内存缓存）


## 五、阶段5：个性化体验升级与插件化（3周）
### 核心目标
提升用户体验，支持通过Bot快速管理个性化功能。

### 任务清单
1. **Bot插件化改造：个性化管理插件**
   - 新增插件：`personality_plugin`
   - 支持命令：
     - `/personality set`：上传微信记录并设置人格
     - `/personality test`：测试当前风格匹配度
     - `/personality switch`：切换个性化模型
   - 技术实现：
     - 插件注册机制：`plugin_registry.py`

2. **用户界面：个性化可视化配置**
   - 功能：
     - 风格特征展示：当前人格的口头禅、句式等
     - 训练进度监控：实时显示微调模型的损失值
     - 风格对比：同时展示“原回复”与“个性化回复”
   - 技术实现：
     - 前端页面：Bootstrap+JS（关联FastAPI接口）

3. **系统监控：个性化效果跟踪**
   - 新增指标：
     - 风格匹配度：回复与目标风格的匹配百分比
     - 记忆关联准确率：记忆与当前对话的关联程度
   - 技术实现：
     - 监控面板：基于`Prometheus+Grafana`（或轻量级日志分析）


## 六、阶段6：可扩展性与社区生态（长期）
### 核心目标
构建个性化功能的生态系统，支持社区贡献。

### 任务清单
1. **插件生态系统：第三方人格模板支持**
   - 功能：
     - 模板标准：定义`PersonalityTemplate`规范（YAML格式）
     - 模板市场：支持社区上传/下载人格模板
     - 模板评分：用户对模板效果打分
   - 技术实现：
     - 模板注册接口：`POST /api/template/upload`

2. **文档与社区建设**
   - 用户文档：《快速开始指南》《个性化配置教程》
   - 开发文档：《插件开发指南》《个性化训练最佳实践》
   - 社区支持：GitHub Issues模板、Discord交流群


## 实施优先级
| 优先级 | 阶段 | 核心任务 |
|--------|------|----------|
| 高 | 阶段1 | 配置系统重构、统一启动入口 |
| 高 | 阶段2 | 提示词管理系统、本地数据存储优化 |
| 中 | 阶段3 | 微信数据处理、模型微调系统 |
| 中 | 阶段4 | 服务选择器、本地模型优化 |
| 低 | 阶段5 | Bot插件化、用户界面 |
| 低 | 阶段6 | 插件生态、社区文档 |


## 交付物清单
| 阶段 | 交付物 |
|------|--------|
| 阶段1 | 重构后的配置系统、日志系统、`run.py`启动脚本 |
| 阶段2 | 提示词管理系统、向量化记忆检索模块 |
| 阶段3 | 微信解析脚本、LoRA微调模型、风格报告生成工具 |
| 阶段4 | 智能路由服务、量化后的本地模型 |
| 阶段5 | 个性化管理插件、可视化配置页面 |
| 阶段6 | 模板标准文档、开发指南、社区交流渠道 |