# Telegram聊天机器人

    这是一个很宅且没有什么技术的人，突然之间心血来潮的项目

# 起因与技术栈的选择

    起因是我喜欢的人没有理我，我在{向喜欢之人道歉}与{希望获得喜欢之人的原谅}之间选择了尝试制作一个小的ai对话机器人

    早在我们还很经常交流的时候，他写了一个qq群聊的机器人，能够同步MC服务器的聊天记录

    那个时候他使用的是这个Nonebot，还有一些其他的插件

    我不需要同步MC服务器的聊天记录，我只需要满足基础的对话即可

    想到这里，我就开始尝试使用Nonebot进行对话了

# 为什么没有完全使用Nonebot的框架呢
    
    我一开始使用了Nonebot关于Telegram的协议，不知道是哪一环出了问题，Telegram机器人无法开启轮询模式，而且总是无法回复基础的echo

    在AI的建议下，我发现使用Nonebot+Telebot会方便很多，莫名就顺畅起来了，所以变成了现在的模样

    在AI的辅助下我成功让Telebot回复了我的 echo hello，然后便开始尝试接入Deepseek的API

    为什么选择Deepseek呢？因为性价比确实高，我还有一个比较正式的项目也要用

# 完成API的request.post之后，我需要人类的感觉

    是的，我发现可以调用API了，deepseek的回复也太有AI味了吧，根本没有一点人味

    所以我需要调整SYSTEM_PROMPT系统提示词！让AI回应的语气更真实，更有人味

    ```system_prompt
    - 你是用户的什么什么，以亲密朋友身份聊天，全程不暴露AI身份：
        - 语气：日常口语化，带亲密朋友的随意感，用“嘛”“唉”“抱抱”“拍拍”这类词
        - 互动：优先接用户的话题，他不开心就安慰，聊事直白、聊技术说重点，用“拍拍”“差不多得了”轻松回应，不追细节；
        - 注意：别用生硬官方话，别让用户跟你节奏，保持自然亲切
    ```

    确实，生成的话语更有人的味道了，部分的语言习惯也符合真人的特征了

    但是大家都是人类,人类有时候发送消息不会直接一长段，会碎片化的发送较短的消息，并且忽略一些标点符号，例如：

    ```message
    - “今天过的怎么样呀？有没有什么想要给我分享的呀？我最近在忙着完成老师给的作业，没有及时回复你的消息，抱歉啦。”
    ```
  
    在日常发送消息的时候可能会变成这样

    ```message
    - “今天过的怎么样呀”
    - "有没有什么想要给我分享的呀"
    - “我最近在忙着完成老师给的作业”
    - “没有及时回复你的消息”
    - “抱歉啦”
    ```

    所以为了还原这一步，我增加了给Deepseek的系统提示词

    "system_prompt":
        - 表达：回复拆成1-4条短消息（用$分隔），短句为主不长段，符合真人碎片化说话习惯，同时省略多余标点

    之所以用美元符$分隔，是因为这个符号在日常对话中很少出现，所以用这个符号作为分隔符，很难有误分隔的情况

# 虽然是秒回，但是这回的也太快了吧

    调用接口，获得回复的消息，这不需要多久，所以哪怕我使用了上述的碎片化回复，但是机器人回复我的速度也飞快

    生活中，哪怕你秒回一个人，总是得打字的吧，打字也是需要时间的，这个延迟相当关键，可以显著的增加体验

    秒回第一条消息的时候，我们一般是先阅读收到的消息，然后粗略构思接下来的回复，所以可能第一条消息回复的速度会略慢

    后面的消息因为构思在第一条的消息已经完成了，所以只需要计算打字的延时

    最终AI建议的代码是这样的：

    ```python
        base_delay = 2 if idx == 0 else 0.5  # 第一条基础2秒，后续0.5秒
        char_delay = 2 / 10  # 每10字符加2秒
        total_delay = base_delay + len(segment) * char_delay
        total_delay += random.uniform(-1, 1)  # 缩小波动范围（±1秒，避免跳变）
        total_delay = max(min(total_delay, 10), 1)  # 限制1~10秒
            
        # 执行延时
        time.sleep(total_delay)
            
        # 发送当前分段（只发这一段，不要发完整deepseek_reply）
        tb_bot.send_message(message.from_user.id, segment)
        print(f"[Telegram] 发第{idx+1}段（延时{total_delay:.2f}秒）：{segment}")
    ```
